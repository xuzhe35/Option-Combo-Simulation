# Option Combo Simulator â€” Development Handover Log

**Target Audience:** Future Developers & AI Assistants  
**Last Updated:** 2026-02-26

---

## 1. Architecture: SSOT via `bsm.js`
All option math is centralized in `bsm.js`. No duplicate calculations exist in the UI/chart/analysis layers.

- **`processLegData(leg, simDate, ivOffset, ...)`** â€” Computes `T`, `calDTE`, `tradDTE`, `simIV`, `posMultiplier`, `costBasis` for a single leg.
- **`computeLegPrice(processedLeg, underlyingPrice, r)`** â€” BSM or intrinsic value (expired).
- **`computeSimulatedPrice(...)`** â€” Wraps `computeLegPrice` with Zero-Delta bypass: in Trial mode at T=0 with no IV offset, uses the live quote directly instead of BSM, eliminating fake P&L drift.

**Rule:** Never write `pos * 100 * price` anywhere outside `bsm.js`.

## 2. Time Convention: Calendar Days / 365
BSM `T = calDTE / 365.0` (matching TWS and industry standard). This correctly prices calendar spreads crossing weekends â€” trading-day-based `T = tradDTE / 252` underestimates weekend time value.

`calendarToTradingDays()` + `MARKET_HOLIDAYS` Set (from `market_holidays.js`) are retained for the informational `Sim DTE: X td / Y cd` display only.

## 3. Monte Carlo Engine (`prob_charts.js`)
- **Student-t distribution** with ticker-specific parameters from `t_params_db.js` (generated by `scripts/fit_underlying.py`).
- Daily vol calibration: `IV / sqrt(365)`.
- Simulation horizon: `nCalDays` (calendar days from baseDate to simulatedDate).
- Expected P&L normalized by total `nPaths` (1M), not clipped bin count â€” ensures full-spectrum tail risk is captured.
- MC worker is **explicitly triggered** via the `ðŸ”„ Recalculate` button, not on every slider drag.

## 4. Dual-Track Cost Basis (Trial vs Active)
- `state.groups[i].viewMode` toggles between `'trial'` (uses current price as cost) and `'active'` (uses historical entry cost).
- Global Chart injects `_viewMode` per-leg when flattening groups, so `chart.js` respects individual group settings.

## 5. Live Market Data (IB Integration)
### Backend (`ib_server.py`)
- **IB library**: uses `ib_async` (`pip install ib_async`) â€” the actively maintained fork of the unmaintained `ib_insync`. Import: `from ib_async import *`. All APIs (`IB`, `connectAsync`, `reqMktData`, `cancelMktData`, `Stock`, `Option`, `pendingTickersEvent`) are identical; only breaking change is `qualifyContractsAsync()` now returns `None` (not an exception) on failure â€” handled with explicit `if not results or results[0] is None` checks.
- **One connection per session**: `connect_ib()` establishes exactly one IB connection for the lifetime of the process. Never calls `connectAsync` again after success.
- **Dynamic client ID (Error 326)**: a temporary `ib.errorEvent` listener captures error codes during the handshake only. If error 326 ("client ID already in use") is received, picks `random.randint(1, 998)` and retries after 1 s. Removed from event bus immediately after each attempt via `finally`.
- **Guaranteed IB disconnect**: `main()` wraps the entire server loop in `try/finally` â€” `ib.disconnect()` always runs on Ctrl+C, SIGTERM, or unhandled exception. `SIGTERM` handler raises `KeyboardInterrupt` so all exits share the same cleanup path.
- **Port 8765 note**: the WebSocket port is released when the Python process exits, not when IB disconnects. On Windows, closing the terminal can orphan the process. If port 8765 is busy on restart, run `Stop-Process -Name python -Force` in PowerShell.
- Multi-client WebSocket: per-connection subscription isolation with reference-counted `cancelMktData`.
- **Option price = `(bid + ask) / 2`** (mark), not `marketPrice()` which returns stale last-trade.
- **IV extraction**: prioritizes `modelGreeks.impliedVol` (Generic Tick 106), falls back to `ticker.impliedVolatility`, with explicit NaN filtering at each step.
- `sync_underlying` action for manual underlying price refresh.

### Frontend (`ws_client.js`)
- `processLiveMarketData()` updates `leg.currentPrice` and `leg.iv`, with `flashElement()` visual feedback.
- IV threshold: `0.000001` to catch microscopic Greek movements.
- Live Market Data checkbox per group; `handleLiveSubscriptions()` dispatched on import.
- Exponential backoff reconnection: 5s â†’ 10s â†’ 20s â†’ 40s â†’ 60s cap, resets on success.
- UI status badge (`#wsStatus`) in sidebar shows connection state in real time.

## 6. Live P&L Display (2026-02-25)
- **Formula**: `(currentPrice - cost) Ã— pos Ã— 100` â€” pure market-based, no BSM, directly comparable to TWS.
- Shown only when both `currentPrice > 0` AND `cost > 0`.
- Displays at **group level** (`.group-live-pnl`) and **global sidebar** (`#globalLivePnL`).
- Hidden (`display: none`) when live data is unavailable.

## 7. Market Holidays (`market_holidays.js`)
- Rule-based engine that dynamically computes NYSE holidays for any year â€” no static data to maintain.
- 10 holidays computed: New Year's, MLK Day, Presidents' Day, Good Friday (Easter algorithm), Memorial Day, Juneteenth, Independence Day, Labor Day, Thanksgiving, Christmas.
- Weekend observance: Saturday holidays â†’ observed Friday; Sunday holidays â†’ observed Monday.
- Results cached per year. Public API: `isMarketHoliday(dateStr)` used by `calendarToTradingDays()` in `bsm.js`.

## 8. File Structure
| File | Purpose |
|------|---------|
| `bsm.js` | BSM pricing, date utils, SSOT engine |
| `app.js` | State management, UI rendering, core calculations, import/export |
| `chart_controls.js` | Chart toggle/range/draw, probability analysis helpers |
| `ws_client.js` | WebSocket connection (exponential backoff), live data processing |
| `chart.js` | P&L curve rendering (Canvas) |
| `prob_charts.js` | Monte Carlo simulation + probability/expected P&L charts |
| `ib_server.py` | IB TWS WebSocket bridge (Python) |
| `t_params_db.js` | Student-t distribution parameters per ticker |
| `market_holidays.js` | NYSE holiday calendar |
| `scripts/fit_underlying.py` | Generate t-distribution params from Yahoo Finance |
| `scripts/gen_holidays.py` | Generate market holiday file |

## 9. Changelog

### 2026-03-01
- **Migration**: `ib_server.py` migrated from unmaintained `ib_insync` to `ib_async` (`pip install ib_async`). Drop-in for all APIs; `qualifyContractsAsync()` now returns `None` on failure instead of raising â€” callers updated to check return value.
- **Auto-disconnect**: `main()` `try/finally` guarantees `ib.disconnect()` on any exit path. `SIGTERM` mapped to `KeyboardInterrupt` so terminal closure and `kill` clean up correctly.
- **Dynamic client ID**: Error 326 (duplicate client ID) triggers automatic retry with a random client ID. Temporary error listener added/removed per connection attempt â€” zero risk of it firing during normal streaming.
- **Port-in-use error**: `OSError` on WebSocket bind now logs an actionable message (`Stop-Process -Name python -Force`) instead of a raw traceback.

### 2026-02-27
- **Tech Debt Fix**: `market_holidays.js` rewritten as a rule-based engine â€” dynamically computes NYSE holidays for any year using Easter algorithm + nth-weekday logic. No more annual regeneration needed.
- **Tech Debt Fix**: `ib_server.py` Deep OTM fallback chain improved: `(bid+ask)/2` â†’ `modelGreeks.optPrice` â†’ `marketPrice()`. Prevents stale last-trade quotes for illiquid options.
- **API change**: `bsm.js` `calendarToTradingDays()` now calls `isMarketHoliday(dateStr)` instead of checking `MARKET_HOLIDAYS` Set directly.

### 2026-02-26
- **Performance**: `setGroupViewMode()` now updates button CSS directly instead of calling `renderGroups()`, eliminating unnecessary DOM re-renders.
- **Performance**: Slider inputs (`underlyingPrice`, `daysPassed`, `ivOffset`) throttled via `requestAnimationFrame` â€” at most one `updateDerivedValues()` per frame.
- **WebSocket reliability**: Reconnection uses exponential backoff (5s â†’ 10s â†’ 20s â†’ 40s â†’ 60s cap), resets on successful connect. UI status badge added to sidebar.
- **Module split**: `app.js` (1128 lines) split into 3 files for maintainability:
  - `app.js` (~700 lines): state, UI events, group/leg management, core calculations, import/export.
  - `chart_controls.js` (~260 lines): chart toggle/range/draw logic, probability analysis helpers.
  - `ws_client.js` (~190 lines): WebSocket connection + live data processing.
- **Random Walk toggle**: Checkbox in Probability Analysis panel to override historical drift (`loc`) with 0, centering the distribution on current price for risk-neutral evaluation.
- **Script load order** updated in `index.html`: `chart_controls.js` â†’ `app.js` â†’ `ws_client.js`.

### 2026-02-25 (Session 2)
- **Live P&L display**: Added `(currentPrice - cost) Ã— pos Ã— 100` at group and global level for TWS comparison.
- **Price fix**: `ib_server.py` switched from `ticker.marketPrice()` (stale last trade) to `(bid + ask) / 2` (mark).
- **IV propagation fix**: Fixed Python operator precedence bug that caused `impliedVolatility` (NaN) to short-circuit, preventing IV from ever being sent to frontend.
- **BSM time convention**: Migrated from `tradDTE / 252` to `calDTE / 365` across all files (bsm.js, prob_charts.js, t_params_db.js). Fixes cross-weekend calendar spread underestimation.
- **Market holidays**: Added `market_holidays.js` + `scripts/gen_holidays.py` for accurate trading-day display.
- **UI fix**: Group summary Live P&L forced to single line (`white-space: nowrap`).

### 2026-02-25 (Session 1)
- **P0 Bug**: Fixed `importFromJSON` `calendarToTradingDays` misuse (single int â†’ two date args).
- **SSOT**: Centralized Zero-Delta bypass into `bsm.js` â†’ `computeSimulatedPrice()`.
- **Global Chart**: Fixed viewMode loss via per-leg `_viewMode` injection.
- **DRY**: `computePortfolioMeanSimIV()` refactored to use `processLegData()`.
- **Utility**: DOM flash animation extracted to `flashElement()`.

### 2026-02-24
- Finalized live IV integration (Generic Tick 106, 4-decimal display, flash effects).
- Cleaned excess debug logging from `ib_server.py`.

### 2026-02-23
- Initial `bsm.js` SSOT refactoring (Sections 1â€“4 above).
- Monte Carlo Expected P&L normalization fix.
- Multi-underlying distribution support (`t_params_db.js`).
- Multi-client WebSocket isolation.
- Dual-track cost basis (Trial/Active).

***
*End of Handover. The project is mathematically synchronized with TWS-compatible pricing conventions.*
