# Option Combo Simulator â€” Development Handover Log

**Target Audience:** Future Developers & AI Assistants  
**Last Updated:** 2026-02-26

---

## 1. Architecture: SSOT via `bsm.js`
All option math is centralized in `bsm.js`. No duplicate calculations exist in the UI/chart/analysis layers.

- **`processLegData(leg, simDate, ivOffset, ...)`** â€” Computes `T`, `calDTE`, `tradDTE`, `simIV`, `posMultiplier`, `costBasis` for a single leg.
- **`computeLegPrice(processedLeg, underlyingPrice, r)`** â€” BSM or intrinsic value (expired).
- **`computeSimulatedPrice(...)`** â€” Wraps `computeLegPrice` with Zero-Delta bypass: in Trial mode at T=0 with no IV offset, uses the live quote directly instead of BSM, eliminating fake P&L drift.

**Rule:** Never write `pos * 100 * price` anywhere outside `bsm.js`.

## 2. Time Convention: Calendar Days / 365
BSM `T = calDTE / 365.0` (matching TWS and industry standard). This correctly prices calendar spreads crossing weekends â€” trading-day-based `T = tradDTE / 252` underestimates weekend time value.

`calendarToTradingDays()` + `MARKET_HOLIDAYS` Set (from `market_holidays.js`) are retained for the informational `Sim DTE: X td / Y cd` display only.

## 3. Monte Carlo Engine (`prob_charts.js`)
- **Student-t distribution** with ticker-specific parameters from `t_params_db.js` (generated by `scripts/fit_underlying.py`).
- Daily vol calibration: `IV / sqrt(365)`.
- Simulation horizon: `nCalDays` (calendar days from baseDate to simulatedDate).
- Expected P&L normalized by total `nPaths` (1M), not clipped bin count â€” ensures full-spectrum tail risk is captured.
- MC worker is **explicitly triggered** via the `ðŸ”„ Recalculate` button, not on every slider drag.

## 4. Dual-Track Cost Basis (Trial vs Active)
- `state.groups[i].viewMode` toggles between `'trial'` (uses current price as cost) and `'active'` (uses historical entry cost).
- Global Chart injects `_viewMode` per-leg when flattening groups, so `chart.js` respects individual group settings.

## 5. Live Market Data (IB Integration)
### Backend (`ib_server.py`)
- Multi-client WebSocket: per-connection subscription isolation with reference-counted `cancelMktData`.
- **Option price = `(bid + ask) / 2`** (mark), not `marketPrice()` which returns stale last-trade.
- **IV extraction**: prioritizes `modelGreeks.impliedVol` (Generic Tick 106), falls back to `ticker.impliedVolatility`, with explicit NaN filtering at each step.
- `sync_underlying` action for manual underlying price refresh.

### Frontend (`ws_client.js`)
- `processLiveMarketData()` updates `leg.currentPrice` and `leg.iv`, with `flashElement()` visual feedback.
- IV threshold: `0.000001` to catch microscopic Greek movements.
- Live Market Data checkbox per group; `handleLiveSubscriptions()` dispatched on import.
- Exponential backoff reconnection: 5s â†’ 10s â†’ 20s â†’ 40s â†’ 60s cap, resets on success.
- UI status badge (`#wsStatus`) in sidebar shows connection state in real time.

## 6. Live P&L Display (2026-02-25)
- **Formula**: `(currentPrice - cost) Ã— pos Ã— 100` â€” pure market-based, no BSM, directly comparable to TWS.
- Shown only when both `currentPrice > 0` AND `cost > 0`.
- Displays at **group level** (`.group-live-pnl`) and **global sidebar** (`#globalLivePnL`).
- Hidden (`display: none`) when live data is unavailable.

## 7. Market Holidays (`market_holidays.js`)
- Static Set of NYSE holiday date strings for accurate trading-day display.
- Generated by `python scripts/gen_holidays.py <year> [year2 ...]` â€” zero-dependency, rule-based (9 holidays including Easter/Good Friday algorithm).
- Currently contains 2026 + 2027. Regenerate annually.

## 8. File Structure
| File | Purpose |
|------|---------|
| `bsm.js` | BSM pricing, date utils, SSOT engine |
| `app.js` | State management, UI rendering, core calculations, import/export |
| `chart_controls.js` | Chart toggle/range/draw, probability analysis helpers |
| `ws_client.js` | WebSocket connection (exponential backoff), live data processing |
| `chart.js` | P&L curve rendering (Canvas) |
| `prob_charts.js` | Monte Carlo simulation + probability/expected P&L charts |
| `ib_server.py` | IB TWS WebSocket bridge (Python) |
| `t_params_db.js` | Student-t distribution parameters per ticker |
| `market_holidays.js` | NYSE holiday calendar |
| `scripts/fit_underlying.py` | Generate t-distribution params from Yahoo Finance |
| `scripts/gen_holidays.py` | Generate market holiday file |

## 9. Changelog

### 2026-02-26
- **Performance**: `setGroupViewMode()` now updates button CSS directly instead of calling `renderGroups()`, eliminating unnecessary DOM re-renders.
- **Performance**: Slider inputs (`underlyingPrice`, `daysPassed`, `ivOffset`) throttled via `requestAnimationFrame` â€” at most one `updateDerivedValues()` per frame.
- **WebSocket reliability**: Reconnection uses exponential backoff (5s â†’ 10s â†’ 20s â†’ 40s â†’ 60s cap), resets on successful connect. UI status badge added to sidebar.
- **Module split**: `app.js` (1128 lines) split into 3 files for maintainability:
  - `app.js` (~700 lines): state, UI events, group/leg management, core calculations, import/export.
  - `chart_controls.js` (~260 lines): chart toggle/range/draw logic, probability analysis helpers.
  - `ws_client.js` (~190 lines): WebSocket connection + live data processing.
- **Random Walk toggle**: Checkbox in Probability Analysis panel to override historical drift (`loc`) with 0, centering the distribution on current price for risk-neutral evaluation.
- **Script load order** updated in `index.html`: `chart_controls.js` â†’ `app.js` â†’ `ws_client.js`.

### 2026-02-25 (Session 2)
- **Live P&L display**: Added `(currentPrice - cost) Ã— pos Ã— 100` at group and global level for TWS comparison.
- **Price fix**: `ib_server.py` switched from `ticker.marketPrice()` (stale last trade) to `(bid + ask) / 2` (mark).
- **IV propagation fix**: Fixed Python operator precedence bug that caused `impliedVolatility` (NaN) to short-circuit, preventing IV from ever being sent to frontend.
- **BSM time convention**: Migrated from `tradDTE / 252` to `calDTE / 365` across all files (bsm.js, prob_charts.js, t_params_db.js). Fixes cross-weekend calendar spread underestimation.
- **Market holidays**: Added `market_holidays.js` + `scripts/gen_holidays.py` for accurate trading-day display.
- **UI fix**: Group summary Live P&L forced to single line (`white-space: nowrap`).

### 2026-02-25 (Session 1)
- **P0 Bug**: Fixed `importFromJSON` `calendarToTradingDays` misuse (single int â†’ two date args).
- **SSOT**: Centralized Zero-Delta bypass into `bsm.js` â†’ `computeSimulatedPrice()`.
- **Global Chart**: Fixed viewMode loss via per-leg `_viewMode` injection.
- **DRY**: `computePortfolioMeanSimIV()` refactored to use `processLegData()`.
- **Utility**: DOM flash animation extracted to `flashElement()`.

### 2026-02-24
- Finalized live IV integration (Generic Tick 106, 4-decimal display, flash effects).
- Cleaned excess debug logging from `ib_server.py`.

### 2026-02-23
- Initial `bsm.js` SSOT refactoring (Sections 1â€“4 above).
- Monte Carlo Expected P&L normalization fix.
- Multi-underlying distribution support (`t_params_db.js`).
- Multi-client WebSocket isolation.
- Dual-track cost basis (Trial/Active).

***
*End of Handover. The project is mathematically synchronized with TWS-compatible pricing conventions.*
